<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>BRZ Custom Hardware - Ludicrous Tech</title>
<meta name="description" content="This page contains any custom PCBs I’ve ordered for the car. The two PCBs currently included are the LightLink module and a custom wake-on-CAN switch, used to cut off power delivery to computers within the car when they are not needed.">


  <meta name="author" content="Serban Popovici">
  
  <meta property="article:author" content="Serban Popovici">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_CA">
<meta property="og:site_name" content="Ludicrous Tech">
<meta property="og:title" content="BRZ Custom Hardware">
<meta property="og:url" content="http://localhost:4000/brz-custom-hardware/">


  <meta property="og:description" content="This page contains any custom PCBs I’ve ordered for the car. The two PCBs currently included are the LightLink module and a custom wake-on-CAN switch, used to cut off power delivery to computers within the car when they are not needed.">







  <meta property="article:published_time" content="2022-10-01T00:00:00-04:00">





  

  


<link rel="canonical" href="http://localhost:4000/brz-custom-hardware/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Serban Popovici",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <!-- <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Ludicrous Tech Feed"> -->


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/favicon.ico" alt="Ludicrous Tech"></a>
        
        <a class="site-title" href="/">
          Ludicrous Tech
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/img/bio.jpg" alt="Serban Popovici" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Serban Popovici</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>BioMedical Mechanical Engineering student at the University of Ottawa</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Ottawa, Ontario, Canada</span>
        </li>
      

      
        
          
            <li><a href="mailto:serpopovici163@gmail.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://ludicroustech.ca" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
        
          
        
          
            <li><a href="https://instagram.com/sketchy.serban" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="BRZ Custom Hardware">
    <meta itemprop="description" content="This page contains any custom PCBs I’ve ordered for the car. The two PCBs currently included are the LightLink module and a custom wake-on-CAN switch, used to cut off power delivery to computers within the car when they are not needed.">
    <meta itemprop="datePublished" content="2022-10-01T00:00:00-04:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/brz-custom-hardware/" class="u-url" itemprop="url">BRZ Custom Hardware
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#lightlink-module-overview">LightLink Module Overview</a><ul><li><a href="#power-protection">Power Protection</a></li><li><a href="#control">Control</a></li><li><a href="#redundant-mosfet-schematic">Redundant MOSFET Schematic</a></li><li><a href="#final-pcb">Final PCB</a></li></ul></li><li><a href="#wake-on-can-switch">Wake-On-CAN Switch</a></li></ul>

            </nav>
          </aside>
        
        <p>This page contains any custom PCBs I’ve ordered for the car. The two PCBs currently included are the LightLink module and a custom wake-on-CAN switch, used to cut off power delivery to computers within the car when they are not needed.</p>

<h2 id="lightlink-module-overview">LightLink Module Overview</h2>

<p>Control of a vehicle’s external lighting is safety critical, so I’ve settled on designing a fully-redundant custom circuit board with 12 MOSFET-driven channels to handle ‘dumb’ lights and 6 addressable channels to handle a set of addressable LED arrays retrofitted throughout the vehicle.</p>

<p>The primary challenges with designing a redundant board for this application are the required use of P-channel MOSFETs and the limited analog I/O available on the Arduino Mega I am using for control. P-channel MOSFETs are required since the car’s chassis is a system-wide ground that all components always have access to and we must therefore toggle the high side of a circuit to reliably turn it on and off. This is an issue because P-channel MOSFETs need their gates to be driven low in order to turn on but the MOSFET operates off of the car’s battery whereas the driving circuit would be operating at a much lower logic-level voltage. Therefore, an intermediary N-channel MOSFET must be used to drive the P-channel from a logic-level signal.</p>

<p>This board has gone through many design iterations with the first being as described <a href="https://circuitjournal.com/how-to-use-a-p-channel-mosfet-with-an-arduino">here</a>. I initially wanted to solely use P-channel MOSFETs (no intermediary N-channel) to decrease the number of components but this seemed like a bad idea so, in the end, I decided to settle for a more traditional design. The final design includes the intermediary N-channel MOSFETs to drive the P-channels and is described more in depth below.</p>

<h3 id="power-protection">Power Protection</h3>

<p>Very few protections were included here since the fuse placed upstream of the board’s power input should do most of the necessary protection. The board itself has its own set of fuses (one for the main power input and a separate one for the 12V input used by the LEDs) in addition to reverse polarity protection on each of the two power inputs. The reverse polarity protection uses two MOSFETs in parallel for redundancy and also to halve the resistance of the reverse polarity protection circuit thereby increasing its efficiency.</p>

<p><img src="/assets/img/brz/custom-hardware/lightlink_V3_PWR_MGMT_schematic.png" alt="MOSFET schematic" /></p>

<p>The power management schematic is pictured above. Power comes in through the left (PWR_IN and 12V_IN nets), immediately meets a fuse, and then passes through P-MOS-based reverse polarity protection. Each power rail then passes through two sets of back-to-back MOSFETs which serve to turn the board on and off; two sets of MOSFETs were once again included for redundancy and to reduce the power dissipated by this circuit. The power leaving these MOSFETs then enters the board-wide Vcc and 12V rails. A SR-latch is constructed in the top right of the schematic which serves to drive the MOSFETs that cut off power to the board; this latch is driven by the INH pin of the TCAN1043DQ1 transceiver to wake the board when it receives a CAN message and can be shut down by a KILL signal from the Arduinos.</p>

<h3 id="control">Control</h3>

<p>Two Arduino Mega EMBEDs are included for control. These were chosen because I have about a dozen on hand right now and they have been reliable in my experience. At any given moment, one of the Arduinos is considered the ‘master’. The master is in charge of outputting signals to the MOSFET and addressable channels while simoultaneously communicating its state to the slave Arduino using a UART connection. The master updates the slave at regular intervals such that the updates themselves function as ‘heartbeat’ signals ensuring the slave that the master is operating normally. Should the master miss an arbitrary amount of heartbeats for whatever reason, the slave sends a hardware reset signal to the master after which it assumes the master role and resumes signal outputs based on the last state update it received.</p>

<p>Each arduino has separate a separate CAN controller and transceiver. I am using the MCP2515 controller alongside the TCAN1043DQ1 transceiver. The MCP2515 is a well known controller and therefore has many libraries available and the TCAN1043DQ1 transceiver was chosen because it has the ability to ‘wake on CAN’. The TCAN1043DQ1 has a separate power pin that does not require an external regulator and allows it to monitor for activity on the CAN bus. Once activity is detected, it sets the INH pin high which turns on the LightLink. This provides a low-power solution to ensure this device does not drain the vehicle’s battery.</p>

<p>In addition to their independent CAN interfaces, each Arduino has its own 5V regulator. I initially wanted to provide a board-wide 5V rail with two regulators in parallel but decided this was a better solution that required less parts overall (no load sharing controllers). This removes the possibility that a short circuit caused by the failure of one Arduino/SPI interface/regulator combination won’t kill the other Arduino/SPI interface/regulator combination.</p>

<h3 id="redundant-mosfet-schematic">Redundant MOSFET Schematic</h3>

<p><img src="/assets/img/brz/custom-hardware/lightlink_mosfet_schematic.png" alt="MOSFET schematic" /></p>

<p>Two P-channel MOSFETs (Q1 and Q3) are included in parallel, both of which are immediately followed by a Schottky diode to prevent backflow from the other MOSFET. This is necessary because a diagnostic pin is included prior to the Schottky to sense the voltage at the output of each MOSFET which would be biased by backflow from the other MOSFET therefore hindering the detection of a MOSFET failure. The diagnostic connections use LM324D-based comparators to compare the voltage before the Schottky to the voltage following the Schottky. If the voltage prior to the diode falls below the voltage following the diode, the output of the LM324D swings low. This is by design since I am using digital pins for sensing MOSFET failures and digital pins can be set up as inputs with pull-up resistors in the Arduino meaning that the pin should go low when a failure occurs.</p>

<p>In addition to detecting individual MOSFET failures, the circuit includes a shunt at the MOSFET output. This allows the board to detect a short circuit or burnt light bulb based on the current being drawn from the circuit. I used single op-amp in a differential configuration to measure the voltage drop across the shunt; I’m not sure if this will work without voltage followers but it costs nothing to add the pads :)</p>

<h3 id="final-pcb">Final PCB</h3>

<p><img src="/assets/img/brz/custom-hardware/lightlink_V3_PCB.png" alt="Final PCB" /></p>

<p>This was a royal pain in the ass to route but I think it turned out rather nice. In the end, I went with a 6-layer board to make my life easier. Of the four internal layers, two are used for power and ground while the other two are used mainly to connect the Arduinos in parallel. I initially chose surface mount headers for the Arduinos (top left) so that there would be no holes in the PCB but these were reasonably-priced, low profile, and had a CAD model available so I stuck with them. The lack of holes under the headers would have made routing this much easier and possibly even doable with a 4-layer board but I’m ok with the way it turned out.</p>

<p><img src="/assets/img/brz/custom-hardware/lightlink_V3_PCB_back.png" alt="Final PCB" /></p>

<p>Altium does show some of the routing going on beneath the top layers when looking at the back of the board. I decided to keep the current sensing signals on the outer layer but mosf of the digital signals have been embedded deeper in the board. I also wired the last four MOSFET channels (9-12) to be PWM capable; all channels are technically PWM capable through software but 9-12 have access to hardware PWM.</p>

<h2 id="wake-on-can-switch">Wake-On-CAN Switch</h2>

<p>The purpose of this board was derived from the development of the <a href="/brz-head-unit">head unit</a>. I needed a way to prevent components from rebooting due to the accessory power cutting off for a split second when the engine starts. My initial solution of using a microcontroller was pretty poor since running a microcontroller 24/7 beats the purpose of a power cutoff board. My second idea of using a RC network, as described in the ‘Behavioural Nightmares’ section of the <a href="/brz-head-unit">head unit</a> page worked, but I wanted more control.</p>

<p>My final solution is to mate a CAN shield with a MOSFET-based power switch. In this manner, I can use the TCAN1043DQ1 transceiver to wake up the board when activity occurs on the CAN bus while also being able to use an external accessory power signal. In order to dictate when the board turns off, the TCAN1043DQ1’s wake up signal and the accessory power signal are multiplexed using an OR gate whose output drives the set pin of a SR latch. A separate ‘kill’ signal can then be provided by an external source to reset the SR latch and turn off the board.</p>

<p><img src="/assets/img/brz/custom-hardware/can_switch_logic_schem.png" alt="CAN switch logic schematic" /></p>

<p>This schematic depicts the general logic of the CAN switch’s logic. The accessory power goes through a voltage divider to drop the battery voltage to a logic-level voltage before the signal gets multiplexed with the INH signal coming from the TCAN1043DQ1. The output of the OR gate goes into an SR latch, constructed of two NOR gates, the output of which drives a N-channel MOSFET which in turn drives two back-to-back P-channel MOSFETs that toggle the power delivery to components downstream from this PCB. Back-to-back MOSFETs are used to nullify the MOSFETs’ body diode and prevent current flow in both directions when the MOSFET switch is off.</p>

<p><img src="/assets/img/brz/custom-hardware/can_switch_transceiver_schem.png" alt="CAN switch transceiver schematic" /></p>

<p>Finally, the SPI-CAN shield is included; this schematic was designed using components with identical sizing to those on my existing SPI-CAN shields to reduce the component cost of this board.</p>

<p><img src="/assets/img/brz/custom-hardware/can_switch_pcb_2D.png" alt="CAN switch PCB 2D" style="width:50%; height:80%;" />
<img src="/assets/img/brz/custom-hardware/can_switch_pcb_3D.png" alt="CAN switch PCB 3D" style="float: right; width:50%; height:80%;" /></p>

<p>This is what the final PCB looks like; not the prettiest thing I know but I can’t really be asked to fix it since it’ll almost certainly work. Only one screwhole is included at the top of the PCB as I’m hoping to mount these by creating ‘slots’ in the 3D-printed parts that house them so the bottom of the PCB would go into a slot after which the top would get secured by that one screw.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2022-10-01T00:00:00-04:00">October 1, 2022</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=BRZ+Custom+Hardware%20http%3A%2F%2Flocalhost%3A4000%2Fbrz-custom-hardware%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fbrz-custom-hardware%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fbrz-custom-hardware%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/brz-CAN/" class="pagination--pager" title="BRZ CAN
">Previous</a>
    
    
      <a href="/brz-gallery/" class="pagination--pager" title="BRZ Gallery
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/hydra/" rel="permalink">HYDRA: Modular Avionics
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          18 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">This page briefly summarized the extensive amount of work that went into designing the avionics system for the University of Ottawa’s rocketry team. We unfor...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/two-stage-rocket/" rel="permalink">Two G-class Stage Rocket w/ Basic Telemetry
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Experimenting with rocketry electronics
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/camera-privacy-hack/" rel="permalink">Security Camera Privacy Hack
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Enhancing privacy of cheap security cameras
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/brz/" rel="permalink">Modernizing my 2013 Subaru BRZ
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">UPDATE
This page is very much under construction, with the nice weather finally here I have begun work on the car and certain things will change/be populated...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="mailto:serpopovici163@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
        
          <li><a href="https://ludicroustech.ca" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
        
      
        
      
        
      
        
          <li><a href="https://instagram.com/discover.ottawa" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
    

    
      <!-- <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> -->
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Serban Popovici. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
