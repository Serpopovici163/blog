---
layout: single
title:  "My Introduction to PCB Design"
toc: true
---

This page briefly summarized the extensive amount of work that went into designing the avionics system for the University of Ottawa's rocketry team. We unfortunately had to scrap last year's work since it was very unorganized and we had absolutely no documentation to work off of. For this project, I was given the requirement that the system be modular, incrimentally upgradeable, and above all well documented. Fortunately, I am a fan of documentation and have included the two primary documents that describe the system below. This blog post will gloss over the design of these boards, however in-depth information is available in the documents below.

- [Hydra Framework](/assets/img/hydra/hydra_framework.docx) --> this document describes the general features that are to be included in each version of Hydra as well as system-wide specifications that must be respected by all Hydra PCBs.
- [Hydra Hardware](/assets/img/hydra/hydra_hardware.docx) --> this document describes board-specific decisions for each PCB within the hardware ecosystem.

Note: at the time of this writing, these documents only include V1 boards which were solely for debugging purposes. We just finished the work on V2 and will be assembling the PCBs in the coming week. (June 23, 2023)

## Design

As previously mentioned, the key focus of this system is modularity. Modularity and redundancy go hand-in-hand in my head so I figured I'd tack that on there as a design requirement. Based on these two requirements, the obvious answer to me was to produce stackable boards that share power buses and communicate through a protocol that can accomodate a flexible amount of hosts without needing rewiring, such as CAN. Seeing as we're building a rocket, the boards should be circular to maximize the area available within the airframe's cross section. Finally, I consulted with the airframe team to establish the position of the mounting holes for the PCBs. From here, we ended up with a finalized set of requirements for each PCB:

- 140mm in diameter (slightly smaller than the 6 inch diameter of the body tube)
- 3 equally-spaced 5.3mm mounting holes (120 degrees apart) in a 60mm radius with the first being located at the top of each PCB (directly above the center)
- 2 standardized connectors on each side of the PCB (2 included for stability, we only really need one)

![Hydra PCB layout](/assets/img/hydra/hydra_PCB_layout.png){: style="width:60%; display:block; margin-left: auto; margin-right: auto;"}

The pinout for each connector was then defined as follows:

![Hydra header pinout](/assets/img/hydra/hydra_header_pinout.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

The left header is the main one used by the system. It provides battery power, regulated 5V, and regulated 3V3 to all the PCBs as well as shared CAN, UART, SPI, and I2C buses. SPI and I2C were included in case we wanted to make any last minute sensor additions or establish a high speed SPI datalink between specific PCBs. UART was included for Hydra V1, to communicate directly with our telemetry radio (an RFD900). In the future, the SPI, I2C, and UART interfaces may be eliminated as they likely won't be particularly useful but we've kept them so far because we have no idea what to replace them with.

### SBG Systems

This system was designed around the [SBG Systems Ellipse2-N INS](https://www.sbg-systems.com/products/ellipse-series/) (Inertial Navigation System) which was 
![SBG](/assets/img/hydra/sbg.jpg){: style="float: right; width:40%; height:100%;"}
generously sponsored to us by SBG Systems. This sensor contains an IMU, barometer, magnetometer, and GPS alongside an MCU running a Kalman filter to ensure accurate data is being sent out of the sensor. From here on out, the Ellipse2-N will be referred to as 'the SBG'.

# Hydra V1

The first version of the system was rushed so that we could have a functional system and prove to [Launch Canada](http://www.launchcanada.org/) that we had a functional avionics system. This system consisted of a simple power board, with two regulators and no other functionality, and a logic board. The logic board was our first PCB containing an MCU and so its purpose was to test whether or not the circuitry surrounding the MCU was done properly. In this version, the MCU simply reads data from the SBG, writes it to the SD card onboard the logic board, and sends an update of the rocket's state over telemetry four times a second. 

## HYDRA_V1_LOGIC

![Hydra V1 logic](/assets/img/hydra/hydra_V1_logic.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

These were my first ever PCBs and I am not awfully proud of them given how messy and poor the design was but everybody's gotta start somewhere I guess. The main purpose of these PCBs was to test if the MCU circuitry was ok and whether our circuitry to interface with the SD card, SBG, and telemetry radio was functional. The only thing that didn't work on this logic board was the programming interface; I did not double check my work and managed to offset the programming pins on the MCU by two so we could not program the MCU. Luckily the firmware was written in Rust so a successful compilation most likely means everything will work. This was a beautiful thing because we ended up getting the board running by programming an MCU on a development board and then transplanting it to the logic board.

## HYDRA_V1_POWER

![Hydra V1 power](/assets/img/hydra/hydra_V1_power.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

The power board is a truly ugly thing but it worked, and it worked well. I ran 10A in a lab through the thinnest traces I could find and it did not even get hot. The purpose of this test was to see if we would need to upgrade to 2oz PCBs but the results confirmed that 1oz boards are fine. On a final note, this board only had reverse polarity protection and was therefore rather lacking in the power protection department. This was fixed in V2. 

# Hydra V2

This is where things got interesting. We ordered an intermediary set of test boards, pictured below, to test the MCU schematics again this time with the programming pins wired where they should be. These boards also allowed us to test CAN between multiple boards which we had not been able to test with the V1 logic board seeing as we couldn't actively debug it. The header on the right side of the PCB (P1) serves to provide power to the board, expose a SERCOM interface on the MCU (allows us to communicate with the chip using a serial protocol such as UART, SPI, etc), and was used to test how much noise a trace would pick up from being close to a crystal (Y1). The trace connected to the bottom right pin of the header follows the outline of Y1 very closely to pick up as much noise as possible.

![MCU test board](/assets/img/hydra/hydra_mcu_test_board.png){: style="width:60%; display:block; margin-left: auto; margin-right: auto;"}

Having confirmed the MCU schematic, we then proceeded to order the V2 boards. It was very important to confirm the MCU layout because each V2 board has an MCU onboard and we must be able to interface with them all. Lastly, I'd like to add that I did not do all of the PCBs listed below; I did all the work for the V2 power board, the layout for the V2 logic board (basically the same thing as V1 but better-looking), modified the layout of the communication board to make it look more like the others, and did the recovery board. I was not supposed to do the recovery board, but the team member responsible for it was unable to complete it and so I took over last minute and threw something together.

## HYDRA_V2_POWER

![Hydra V2 power](/assets/img/hydra/hydra_V2_power.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This is the board I focused on and the only one I'd consider worthy of the Hydra name. This PCB provides redundant 5V and 3V3 rails to the avionics stack, can turn off any specific regulator individually or even cut avionics power outright, and contains a wealth of protections such as over-current, over-voltage, over-discharge (software-based), thermal cut-off (software- and hardware-based), and reverse polarity. Additionally, the board has a variety of voltage sensors throughout, current sensing at the input, and thermal sensors on each regulator. The MCU of this board is powered by its own internal regulators such that it remains online even if the over-current protection trips and can therefore notify the ground station of the failure and reset the current latch. Below are a couple system diagrams of the V2 power board.

*IMG* parent diagram

Power can come in through either one of two connectors: the battery connector or the ground power connector. Ground power is not used in this year's rocket but was included regardless to test the circuitry for future designs. This connector would allow the avionics to power themselves from a power source external to the rocket while the rocket is sitting on the launch pad in order to avoid draining the battery. Once we pass the ground power switch, there is a safety switch stage. These are mechanical switches that interact with a rod protruding through the airframe; when the rod is inserted, the power board is turned off. These switches are positioned sideways to decrease their vertical profile but also to prevent them from accidentally actuating in a high-acceleration event. Past the safety switches, we enter the power protection stage. At this stage, the power first goes through reverse polarity protection after which it diverges into two channels: one goes through the remaining protection circuits and another provides an internal power rail. This internal rail is always active regardless of whether the over-current or over-voltage protection has tripped and is therefore intended for use by the internal regulators that power the MCU. Additionally, this always-on power rail has its own fuse and is used to ignite the pyrotechnics inside the rocket. Doing so alleviates the risk of the over-current latch accidentally tripping due to the sudden change in current required by the pyrotechnic igniters. I'd also like to add that the reverse polarity protection was kept for the pyrotechnics rail to prevent the igniters going off during a reverse polarity event, as the body diode of the MOSFETs that drive the ignitors (on the recovery board) would conduct in a reverse polarity event.

*IMG* regulator stage

Once we're through the power protection stage, the power now reaches the main regulators of the power board. The 3V3 and 5V regulator schematics are virtually identical so I will focus on a single regulator stage, pictured above. There are two regulators that each pass through a separate MOSFET stage before reaching the power rail. The MOSFETs are driven by *PART NUM* load-sharing ICs. These sense the voltage immediately prior to the MOSFET stage as well as the voltage immediately following the MOSFET stage. They then regulate how excited the MOSFET stage is which is correlated to how much resistance the MOSFET stage adds between the regulator and the rail. In this manner, the IC can ensure that the voltage of both regulators immediately following the MOSFET stage is equal and they can therefore equally share the load they are supplying.

### Power protection (in depth)

I really like the power protection circuit on this PCB and will go more in detail eventually.

## HYDRA_V2_LOGIC

![Hydra V2 logic](/assets/img/hydra/hydra_V2_logic.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This is definitely the prettiest one of the lot. It's an awfully simple board and its schematic is identical to that of the V1 logic board, however we added some MOSFETs to cut off power to the SBG and fixed the programming header/swapped it out for a different one. The MOSFETs were included to help but the board to sleep since the SBG consumes more current than the remaining avionics combined. The programming header was swapped with one that matches our debugger (the Segger J-Link EDU Mini) so that these boards can be plug and play to debug. The pinout was also fixed and made to match the Segger's I/O.

## HYDRA_V3_COMMUNICATION

![Hydra V3 communication](/assets/img/hydra/hydra_V3_communication.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This board is labelled V3 since we effectively fast-tracked to the feature set we planned for Hydra V3. Hydra V1 and V2 were meant to have the logic board interface directly with the RFD900 through the UART bus of the left header on the PCB. I felt it was a waste of money to order a PCB this size with 4 traces (power and data for the RFD900) so we designed the V3 board and ordered it instead. That being said, there are still some traces with pads that can be soldered across to connect the RFD900's UART directly to the left header. Our software team is confident they can program this board on time so these likely won't get used; instead, the RFD900 will interface with an MCU on the communication board which enables it to interact directly with the avionics CAN bus. This is much better design since our telemetry no longer depends on the availability of the logic board and we can communicate with each PCB within the system directly. Additionally, the MCU on the communication board has very little to do thereby mitigating the risk of it getting overloaded and alleviating the logic board of a task.

An interesting last-minute addition made to this board is the use of internal regulators. These regulators leech off of the pyrotechnics power bus on the right header of the PCB. The pyrotechnics bus is always on, regardless of whether the current latch on the power board has tripped which enables us to maintain telemetry with he avionics system even if the power protection cuts off power to the rest of the avionics. This was done primarily to allow the power board to put the avionics to sleep while the rocket is sitting on the launch pad. Sleep mode was initially meant to be a software concern but I figured there was no reason to give them more work when we have a power board that is perfectly capable of cutting power to the avionics using hardware. It is also important to note that the communication board has a failover circuit that allows it to fail over to the avionics power buses on the left header of the PCB if its internal regulators fail.

## HYDRA_V2_RECOVERY

![Hydra V2 recovery](/assets/img/hydra/hydra_V2_recovery.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This board has its fair share of issues and I will likely redesign it prior to competition. Its main purpose is to ignite pyrotechnics using e-matches to deploy the parachutes of the rocket. In addition to this, we decided to include a backup sensor package that allows the recovery board to act independently even if the logic board goes offline. The logic behind this likely won't be implemented in time for competition this year since we'd ideally need three sensor packages to be able to discriminate between them and positively identify if one of them is an outlier.

The rectangular shape to the left is a mounting point for a [RRC3](https://www.apogeerockets.com/Electronics-Payloads/Altimeters/RRC3-Sport-Altimeter) which acts as our redundant deployment system.

The problems with this design are as follows:

- Safety rod placement --> This board also has safety rods, like the power board, to disconnect the pyrotechnics from the pyrotechnics power bus which is always on as long as the power board's safety rod is removed. The recovery board's launch rod currently interferes slightly with the cutout at the rear of the PCB which is intended to allow wires to pass through. This would be something we could fix if it wasn't for the RRC3's power connector which is placed in a spot that requires its wires to go past the launch rod in order to reach the wire cutout.
- Ignition detection --> I added status LEDs above the right header which will turn on whenever the MCU or RRC3 send a signal to ignite a recovery method. For whatever reason, I did not connect the signals going to these LEDs to the MCU so the MCU has no way of confirming that the recovery board circuitry did in fact work. The pyrotechnics channels driven by the MCU have continuity testing which is tied to the MCU and could be used to figure out if the e-match detonated but we should still allow the MCU to sense the voltage on the pyrotechnics channels.

Beyond this there are a few small issues like aesthetics or the fact that the MCU can't sense the voltage of the pyrotechnics rail but these things can wait until V3.

## V2 vs V1

We have not assembled V2 yet but I will add those pictures asap. We got the V2 boards in purple to better contrast with the red SBG :)

![Hydra V1 logic board with SBG](/assets/img/hydra/hydra_v1_sbg.jpg){: style="float: left; width:50%; height:80%;"}
![Hydra V1 stacked](/assets/img/hydra/hydra_v1_stacked.jpg){: style="float: right; width:50%; height:80%;"}
![Hydra V2 logic board with SBG](/assets/img/hydra/hydra_v2_sbg.jpg){: style="float: left; width:50%; height:80%;"}
![Hydra V2 stacked](/assets/img/hydra/hydra_v2_stacked.jpg){: style="float: right; width:50%; height:80%;"}