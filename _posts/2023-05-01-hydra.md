---
layout: single
title:  "HYDRA: Modular Avionics"
toc: true
---

This page briefly summarizes the extensive amount of work that went into designing the avionics system for the University of Ottawa's rocketry team. We unfortunately had to scrap last year's work since it was very unorganized and we had absolutely no documentation to work off of. For this project, I was given the requirement that the system be modular, incrimentally upgradeable, and above all well documented. Fortunately, I am a fan of documentation and have included the two primary documents that describe the system below. This blog post will gloss over the design of these boards, however in-depth information is available in the documents below. I would also like to add that this was my first project involving PCB design, hence the very poor design of the V1 boards depicted below.

- [Hydra Framework](/assets/img/hydra/hydra_framework.docx) --> this document describes the general features that are to be included in each version of Hydra as well as system-wide specifications that must be respected by all Hydra PCBs.
- [Hydra Hardware](/assets/img/hydra/hydra_hardware.docx) --> this document describes board-specific decisions for each PCB within the hardware ecosystem.

## Design

### Hydra V1 & V2

As previously mentioned, the key focus of this system is modularity. Modularity and redundancy go hand-in-hand in my head so I figured I'd tack that on there as a design requirement. Based on these two requirements, the obvious answer to me was to produce stackable boards that share power buses and communicate through a protocol that can accomodate a flexible amount of hosts without needing rewiring, such as CAN. Seeing as we're building a rocket, the boards should be circular to maximize the area available within the airframe's cross section. Finally, I consulted with the airframe team to establish the position of the mounting holes for the PCBs. From here, we ended up with a finalized set of requirements for each PCB:

- 140mm in diameter (slightly smaller than the 6 inch diameter of the body tube)
- 3 equally-spaced 5.3mm mounting holes (120 degrees apart) in a 60mm radius with the first being located at the top of each PCB (directly above the center)
- 2 standardized connectors on each side of the PCB (2 included for stability, we only really need one)

![Hydra V1/V2 PCB layout](/assets/img/hydra/hydra_PCB_layout.png){: style="width:60%; display:block; margin-left: auto; margin-right: auto;"}

The pinout for each connector was then defined as follows:

![Hydra header pinout](/assets/img/hydra/hydra_header_pinout.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

The left header is the main one used by the system. It provides battery power, regulated 5V, and regulated 3V3 to all the PCBs as well as shared CAN, UART, SPI, and I2C buses. SPI and I2C were included in case we wanted to make any last minute sensor additions or establish a high speed SPI datalink between specific PCBs. UART was included for Hydra V1, to communicate directly with our telemetry radio (an RFD900). In the future, the SPI, I2C, and UART interfaces may be eliminated as they likely won't be particularly useful but we've kept them so far because we have no idea what to replace them with.

### Hydra V3

Due to my Master's beginning in January, I have the opportunity to continue working with the uOttawa rocketry team for a semester following the Launch Canada 2023 competition and continue developing this modular avionics system. The goal for my final semester is to iron out some bugs of the system, upgrade the boards from the current ATSAME51J18A MCU to the STM32H733VGT6, and shrink the system from 140mm in diameter to 50mm in diameter. The new PCB format for Hydra V3 PCBs is as follows:

![Hydra V3 PCB layout](/assets/img/hydra/hydra_V3_PCB_layout.png){: style="width:60%; display:block; margin-left: auto; margin-right: auto;"}

No mounting provisions are made for Hydra V3 to maximize usable PCB space and the system is intended to be clamped in place from either end. A larger cutout is included at the rear of the system to improve access to wires since the locking connectors used by Hydra V2 were often poorly placed and difficult to mate/unmate with the stack assembled. The flat cutout should make it easy to place connectors at the edge of the PCB and facilitate mate/unmating peripherals. Lastly, due to the small size of the new system, the SBG, RFD900, and battery will now need to be mounted outside of the avionics stack. The system itself is heavily inspired by the [Martlet III](https://gregox.com/cusf_martlet3/) system and may therefore evolve to contain 18650s within the avionics stack, much like the Martlet III stack. The Martlet III uses 40mm PCBs but I did not want new recruits to struggle miniaturizing things to that extent so we settled on 50mm as it would still fit all the small rockets that the uOttawa rocketry team owns. This was very important as it will enable us to cost-effectively test fly the system regularly.

Beyond the changes outlined above, Hydra V3 will also shift towards more aerospace-grade hardware such as more resilient connectors and arming system; these changes are outlined in the Hydra-Framework document linked above. The new connector pinout for Hydra V3 is as follows:

![Hydra header pinout](/assets/img/hydra/hydra_V3_header_pinout.PNG){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This pinout drops a lot of the data protocols included in the V1/V2 pinout since the system requirements are clearer now and there is no need to include exposed I2C, SPI, or UART interfaces for last minute hardware changes. Moreover, the new pinout focuses on power capacity over data and now includes two CAN buses: one for commands and another for sensor data. The software team had issues with sending commands within the V2 system because the CAN messages representing commands would get drowned in sensor data and V3 will therefore segregate sensor and command data in two separate CAN buses. This also technically provides the system with redundant CAN buses :) 

Lastly, the right header of the Hydra V3 system is dedicated to power transport and has been made into a large avionics-wide power bus. This change compliments the HYDRA_V3_POWER board design which is detailed further along in this post.

### SBG Systems

This system was designed around the [SBG Systems Ellipse2-N INS](https://www.sbg-systems.com/products/ellipse-series/) (Inertial Navigation System) which was 
![SBG](/assets/img/hydra/sbg.jpg){: style="float: right; width:40%; height:100%;"}
generously sponsored to us by SBG Systems. This sensor contains an IMU, barometer, magnetometer, and GPS alongside an MCU running a Kalman filter to ensure accurate data is being sent out of the sensor. From here on out, the Ellipse2-N will be referred to as 'the SBG'.

## Hydra V1

The first version of the system was rushed so that we could have a functional system and prove to [Launch Canada](http://www.launchcanada.org/) that we had a functional avionics system. This system consisted of a simple power board, with two regulators and no other functionality, and a logic board. The logic board was our first PCB containing an MCU and so its purpose was to test whether or not the circuitry surrounding the MCU was done properly. In this version, the MCU simply reads data from the SBG, writes it to the SD card onboard the logic board, and sends an update of the rocket's state over telemetry four times a second. 

### HYDRA_V1_LOGIC

![Hydra V1 logic](/assets/img/hydra/hydra_v1_logic.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

These were my first ever PCBs and I am not awfully proud of them given how messy and poor the design was but everybody's gotta start somewhere I guess. The main purpose of these PCBs was to test if the MCU circuitry was ok and whether our circuitry to interface with the SD card, SBG, and telemetry radio was functional. The only thing that didn't work on this logic board was the programming interface; I did not double check my work and managed to offset the programming pins on the MCU by two so we could not program the MCU. Luckily the firmware was written in Rust so a successful compilation most likely means everything will work. This was a beautiful thing because we ended up getting the board running by programming an MCU on a development board and then transplanting it to the logic board.

### HYDRA_V1_POWER

![Hydra V1 power](/assets/img/hydra/hydra_v1_power.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

The power board is a truly ugly thing but it worked, and it worked well. I ran 10A in a lab through the thinnest traces I could find and it did not even get hot. The purpose of this test was to see if we would need to upgrade to 2oz PCBs but the results confirmed that 1oz boards are fine. On a final note, this board only had reverse polarity protection and was therefore rather lacking in the power protection department. This was fixed in V2. 

## Hydra V2

This is where things got interesting. We ordered an intermediary set of test boards, pictured below, to test the MCU schematics again this time with the programming pins wired where they should be. These boards also allowed us to test CAN between multiple boards which we had not been able to test with the V1 logic board seeing as we couldn't actively debug it. The header on the right side of the PCB (P1) serves to provide power to the board, expose a SERCOM interface on the MCU (allows us to communicate with the chip using a serial protocol such as UART, SPI, etc), and was used to test how much noise a trace would pick up from being close to a crystal (Y1). The trace connected to the bottom right pin of the header follows the outline of Y1 very closely to pick up as much noise as possible.

![MCU test board](/assets/img/hydra/hydra_mcu_test_board.png){: style="width:60%; display:block; margin-left: auto; margin-right: auto;"}

Having confirmed the MCU schematic, we then proceeded to order the V2 boards. It was very important to confirm the MCU layout because each V2 board has an MCU onboard and we must be able to interface with them all. Lastly, I'd like to add that I did not do all of the PCBs listed below; I did all the work for the V2 power board, the layout for the V2 logic board (basically the same thing as V1 but better-looking), modified the layout of the communication board to make it look more like the others, and did the recovery board. I was not supposed to do the recovery board, but the team member responsible for it was unable to complete it and so I took over last minute and threw something together.

### HYDRA_V2_POWER

![Hydra V2 power](/assets/img/hydra/hydra_v2_power.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This is the board I focused on and the only one I'd consider worthy of the Hydra name. This PCB provides redundant 5V and 3V3 rails to the avionics stack, can turn off any specific regulator individually or even cut avionics power outright, and contains a wealth of protections such as over-current, over-voltage, over-discharge (software-based), thermal cut-off (software- and hardware-based), and reverse polarity. Additionally, the board has a variety of voltage sensors throughout, current sensing at the input, and thermal sensors on each regulator. The MCU of this board is powered by its own internal regulators such that it remains online even if the over-current protection trips and can therefore notify the ground station of the failure and reset the current latch. The empty space left near the top mounting hole and on the bottom right, around the ground power switch logic section, is to accomodate 3D-printed pieces that will help guide the safety rod which interacts with the two safety switches on the PCB. This rod passes through the airframe and is inserted to cut power to the avionics prior to flight. Two power switches are included to combine their current capacity and also for redundancy.

Below are a couple system diagrams of the V2 power board.

![Hydra V2 power parent system diagram](/assets/img/hydra/hydra_v2_power_parent_system_diagram.png){: style="width:100%; display:block; margin-left: auto; margin-right: auto;"}

Power can come in through either one of two connectors: the battery connector or the ground power connector. Ground power is not used in this year's rocket but was included regardless to test the circuitry for future designs. This connector would allow the avionics to power themselves from a power source external to the rocket while the rocket is sitting on the launch pad in order to avoid draining the battery. Once we pass the ground power switch, there is a safety switch stage. These are mechanical switches that interact with a rod protruding through the airframe; when the rod is inserted, the power board is turned off. These switches are positioned sideways to decrease their vertical profile but also to prevent them from accidentally actuating in a high-acceleration event. Past the safety switches, we enter the power protection stage. At this stage, the power first goes through reverse polarity protection after which it diverges into two channels: one goes through the remaining protection circuits and another provides an internal power rail. This internal rail is always active regardless of whether the over-current or over-voltage protection has tripped and is therefore intended for use by the internal regulators that power the MCU. Additionally, this always-on power rail has its own fuse and is used to ignite the pyrotechnics inside the rocket. Doing so alleviates the risk of the over-current latch accidentally tripping due to the sudden change in current required by the pyrotechnic igniters. I'd also like to add that the reverse polarity protection was kept for the pyrotechnics rail to prevent the igniters going off during a reverse polarity event, as the body diode of the MOSFETs that drive the ignitors (on the recovery board) would conduct in a reverse polarity event.

![Hydra V2 power redundant regulator system diagram](/assets/img/hydra/hydra_v2_power_regulator_system_diagram.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

Once we're through the power protection stage, the power now reaches the main regulators of the power board. The 3V3 and 5V regulator schematics are virtually identical so I will focus on a single regulator stage, pictured above. There are two regulators that each pass through a separate MOSFET stage before reaching the power rail. The MOSFETs are driven by *PART NUM* load-sharing ICs. These sense the voltage immediately prior to the MOSFET stage as well as the voltage immediately following the MOSFET stage. They then regulate how excited the MOSFET stage is which is correlated to how much resistance the MOSFET stage adds between the regulator and the rail. In this manner, the IC can ensure that the voltage of both regulators immediately following the MOSFET stage is equal and they can therefore equally share the load they are supplying.

#### Power protection (in depth)

This was my first time designing proper power protection circuitry and I'm rather fond of how it turned out. A system diagram of the power protection schematic is included below.

![Hydra V2 power protection system diagram](/assets/img/hydra/hydra_v2_power_protection_system_diagram.png){: style="width:100%; display:block; margin-left: auto; margin-right: auto;"}

The power first goes through a main fuse before reaching the reverse polarity protection. This parent fuse should be virtually impossible to blow as the pyrotechnics fuse and over-current latch should prevent the board from ever drawing enough current to blow the main fuse. The internal power rail, used to power the board's internal regulators as well as the pyrotechnics power bus, immediately follows the reverse polarity protection stage. The remaining current flows into the over-current latch which was taken from a [TI paper](https://www.ti.com/lit/ml/snoaa39/snoaa39.pdf?ts=1680252597482) decribing op-amp-based over-current protection. Having passed through the over-current latch, the power is then able to reach the regulators.

![Reverse polarity protection schematic](/assets/img/hydra/mosfet_reverse_polarity_protection.webp){: style="float: right; width:40%; height:100%;"}

The reverse polarity protection follows a relatively standard configuration involving a P-channel MOSFET, zener, and a current-limiting resistor, as pictured to the right. This protection works because the MOSFET's gate is tied to ground through the current-limiting resistor; in normal operating conditions, this means that the MOSFET will be turned on. During a reverse polarity event, ground becomes positive and the gate of the MOSFET loses its negative bias meaning that the MOSFET will no longer conduct. Furthermore, the body diode of the MOSFET only allows current to flow in the right direction and the zener is used to ensure that the gate-source voltage never exceeds the maximum voltage that the MOSFET is rated for.

![Over-current protection schematic](/assets/img/hydra/over_current_protection_schematic.png){: style="float: right; width:40%; height:100%;"}

The over-current protection is a rather beautiful and yet simple circuit. It essentially works by using a precise voltage divider (R2/R3) to set the voltage at the non-inverting input (Vp) of the op amp to represent the maximum allowable voltage drop across the shunt (R1). Normally, Vp will be lower than the post-shunt voltage (Vn) and the op-amp's output will therefore be low. The low output pulls the gate of the P-channel MOSFET (T1) low, thereby allowing current to flow into the load. During an over-current event, Vn drops below Vp allowing the output of the op amp to swing high. This not only cuts off the MOSFET but it also sets the bottom of the R2/R3 voltage divider high. Considering that no current will be flowing through the shunt if the MOSFET is cut off, this means that Vp ~ Vn and the op-amp will latch in its hysteresis region. Ona  final note, the capacitor C1 is included to pull Vp low and prevent the system from accidentally tripping on boot. 

I've modified this circuit in three ways:

1. I've added the ability to artificially trip the current latch by using an N-channel MOSFET and resistor in series which will pull Vn to ground using a logic-level input.
2. I've added the ability to reset the current latch with an identical N-channel MOSFET and resistor circuit pulling the comparator's output low. This forcefully turns on the MOSFET and re-establishes the correct voltage output from the R2/R3 divider thereby resetting the circuit.
3. I've added current sensing off of the same shunt (R1). I'm not sure if this is a good idea but we're gonna find out :) It's not a mission critical item so we can easily just omit it on the final PCB. The current sense circuitry uses a dedicated shunt IC; I had initially made my own instrumentation amplifier but decided it was probably best to use a dedicated IC to save PCB area and design complexity.

Two voltage sensing circuits are included prior to the over-current
![Voltage sense schematic](/assets/img/hydra/voltage_sense_schematic.png){: style="float: right; width:40%; height:100%;"}
latch: one providing sensing data to the MCU, and another for over-voltage protection. 
The MCU sensing circuit (pictured to the right) uses a simple voltage divider with a Zener diode to prevent the voltage at the MCU from ever exceeding 3.3V given that it senses voltage prior to the over-voltage protection. 

The over-voltage protection is concatenated with the over-current latch in that it uses a comparator to produce a logic high signal when an over-voltage condition occurs. This logic high signal is then used to artificially trip the current latch using an N-channel MOSFET and resistor in series. It uses the exact same circuit as previously described in the list describing features I've added to the over-current latch. The over-voltage protection depicted below works by comparing the output of the MCU's voltage sense divider (picture above) to a predetermined reference. R29 and D4 produce a 3.3V reference which is then passed through a voltage divider (R30/R31) whose resistors we can tune in a lab to output a value representative of the maximum allowable voltage for the PCB. If the MCU's voltage sense divider ever outputs a value above our maximum allowable voltage, the output of U4 swings high and forces the over-current latch to trip thereby curring power to the board.

![Over-voltage protection schematic](/assets/img/hydra/over_voltage_protection_schematic.png){: style="width:100%; display:block; margin-left: auto; margin-right: auto;"}

### HYDRA_V2_LOGIC

![Hydra V2 logic](/assets/img/hydra/hydra_v2_logic.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This is definitely the prettiest one of the lot. It's an awfully simple board and its schematic is identical to that of the V1 logic board, however we added some MOSFETs to cut off power to the SBG and fixed the programming header/swapped it out for a different one. The MOSFETs were included to help put the board to sleep since the SBG consumes more current than the remaining avionics combined. The programming header was swapped with one that matches our debugger (the Segger J-Link EDU Mini) so that these boards can be plug and play to debug. The pinout was also fixed and made to match the Segger's I/O header.

### HYDRA_V3_COMMUNICATION

![Hydra V3 communication](/assets/img/hydra/hydra_v3_communication.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This board is labelled V3 since we effectively fast-tracked to the feature set we planned for Hydra V3. Hydra V1 and V2 were meant to have the logic board interface directly with the RFD900 through the UART bus on the left header of the PCB. I felt it was a waste of money to order a PCB this size with 4 traces (power and data for the RFD900) so we designed the V3 board and ordered it instead. That being said, there are still some traces with pads that can be soldered across to connect the RFD900's UART directly to the left header. Our software team is confident they can program this board on time so these likely won't get used; instead, the RFD900 will interface with an MCU on the communication board which enables it to interact directly with the avionics CAN bus. This is much better design since our telemetry no longer depends on the availability of the logic board and we can communicate with each PCB within the system directly. Additionally, the MCU on the communication board has very little to do thereby mitigating the risk of it getting overloaded and alleviating the logic board of a task.

An interesting last-minute addition made to this board is the use of internal regulators. These regulators leech off of the pyrotechnics power bus on the right header of the PCB. The pyrotechnics bus is always on, regardless of whether the current latch on the power board has tripped which enables us to maintain telemetry with he avionics system even if the power protection cuts off power to the rest of the avionics. This was done primarily to allow the power board to put the avionics to sleep while the rocket is sitting on the launch pad. Sleep mode was initially meant to be a software concern but I figured there was no reason to give them more work when we have a power board that is perfectly capable of cutting power to the avionics using hardware. It is also important to note that the communication board has a failover circuit that allows it to fail over to the avionics power buses on the left header of the PCB if its internal regulators fail.

### HYDRA_V2_RECOVERY

![Hydra V2 recovery](/assets/img/hydra/hydra_v2_recovery.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This board has its fair share of issues and I will likely redesign it prior to competition. Its main purpose is to ignite pyrotechnics using e-matches to deploy the parachutes of the rocket. In addition to this, we decided to include a backup sensor package that allows the recovery board to act independently even if the logic board goes offline. The logic behind this likely won't be implemented in time for competition this year since we'd ideally need three sensor packages to be able to discriminate between them and positively identify if one of them is an outlier.

The rectangular shape to the left is a mounting point for a [RRC3](https://www.apogeerockets.com/Electronics-Payloads/Altimeters/RRC3-Sport-Altimeter) which acts as our redundant deployment system.

### System Comparison: V2 vs V1

The top two pictures show Hydra V1 which solely had a logic board and used two consumer [RRC3](https://www.apogeerockets.com/Electronics-Payloads/Altimeters/RRC3-Sport-Altimeter) recovery systems in parallel as opposed to our custom recovery board used by V2. The bottom pictures shows the final Hydra V2 stack prior to launch.

![Hydra V1 logic board with SBG](/assets/img/hydra/hydra_v1_sbg.jpg){: style="float: left; width:50%; height:80%;"}
![Hydra V1 stacked](/assets/img/hydra/hydra_v1_stacked.jpg){: style="float: right; width:50%; height:80%;"}
![Hydra V2 stacked](/assets/img/hydra/hydra_v2_stacked.jpg)

In practice, this system performed admirably. Thanks to contributions from the software team, we had an extensive ground station suite that logged thousands of data points during the rockets flight enabling us to recover the vehicle in no time. Furthermore, the onboard SD card of the V2 logic board logged over 6 million data points with regards to the rocket's state during its 30 minute flight enabling us to further gain insight into the airframe's behaviour.

## Hydra V3

This system is still currently in its inception so most PCBs don't exist yet. I've currently created a template PCB containing barebones circuitry common to all Hydra V3 PCBs. This project still uses the old ATSAME51J18A MCU such that we can work on developing the MCU circuitry for the STM32H733VGT6 MCU in parallel with the first round of avionics boards. Once the STM32H733VGT6 MCU circuitry is completed, it should be easy to replace the MCU and reorder Hydra V3 PCBs with the upgraded processor.

### HYDRA_V3_SAME51_TEMPLATE

![Hydra V3 SAME51 template](/assets/img/hydra/hydra_V3_SAME51_template.png){: style="width:80%; display:block; margin-left: auto; margin-right: auto;"}

This is the aforementioned template project that has some sample connectors and status LEDs since the position of such features has been standardized in V3 as per the Hydra Framework document linked at the top of this page. More details are available in the Hydra Hardware documentation linked at the top of this post. I also added quite a few test points to facilitate debugging hardware as this was a regular challenge with V2 PCBs.