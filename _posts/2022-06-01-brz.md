---
layout: single
title:  "Modernizing my 2013 Subaru BRZ"
toc: true
---

I recently acquired a car for recreational purposes since I had saved up a decent amount of money and didn't feel like investing it. I purchased a BRZ because they are built in conjunction with Toyota and this should theoretically imply that they are relatively reliable so I won't need to worry about the mechanical aspect of the vehicle. Furthermore, this colaboration with Toyota also makes them relatively easy to work on at home which I am thankful for since I've had to do a wealth of maintenance on it even going as far as removing failing drivetrain elements.

# Idea

## UI Enhancements

![Picture of plan](/assets/img/brz/planned_display_layout.jpg){: style="float: right; width:50%; height:80%; margin-left: 10px;"}

The plan is to replace the head unit of the BRZ with a [12.3" touch-screen](https://www.aliexpress.com/item/1005003546521274.html), replace the small button cluster on the center console with a [7" touch screen](https://www.aliexpress.com/item/4000393713339.html), convert the analog gauge cluster to a display, and potentially add a heads up display in the windshield. The 12.3" display will be used for most vehicle functionality such as navigation and media whereas the 7" display will provide diagnostic information about the vehicle as well as any subsystems I add. Ideally, the computer running the 7" display will have access to the car's internal computer to provide any information from DTC/SRS/ABS codes to general information about things like tire pressure.

The car will have an LTE modem in it to provide WiFi connectivity for passengers and allow its internal computers to access Google Maps, media streaming services, and other resources such as the Waze database to protect against police encounters. Finally, I hope to add cameras all around the car and experiment with computer vision though, aside from collision warnings and enhanced cruise control I'm not sure what I'll be able to develop. The cameras will however provide a 360-degree dash cam and I will be able to use them for a Tesla-like sentry mode when the car is locked. 

## Speed Enforcement Countermeasures

I'm hoping to, at the very least, add passive sensors for police radar/lidar and possibly even aircraft but I may not be able to add active countermeasures such as radar/lidar jamming. Based on some brief research, there is a significant risk that the officer's radar/lidar gun would detect my jamming attempts since many of them have jamming detection built in and proper commercial lidar jammers are designed to identify the specific make/model of a lidar gun and behave accordingly. 

Aircraft countermeasures are more reasonably achieveable since aircraft speed detection works using lines painted on the pavement at a known distance interval such that an aircraft flying above can time a vehicle crossing a set of these lines. My plan for countering this is to use a front facing camera on the car to pick up the lines at which point an onboard computer will use a software defined radio to look for any aircraft transponders within a certain radius of the vehicle. Should there be an aircraft nearby, the onboard computer will begin calling out speeds for the user to match in hopes that the average speed across the two lines does not exceed the posted limit.

An even more complex countermeasure I'm hoping to integrate is cellular sniffing where a computer would once again use a software defined radio to look for nearby cellular devices and fingerprint them to single out the specific make and model of cellular modem present in a Ford Interceptor. I'm unsure if this is even theoretically possible since newer cellular devices may encrypt everything but I intend to research this in depth.

In addition to passive countermeasures and radar/lidar jammers, the vehicle will hopefully have cellular and VHF/UHF jammers. The purpose of these is to prevent a Ford Interceptor's cellular modem and radio from working when in close proximity to the vehicle. This way the officer will not be able to run the driver's license or even issue tickets and this could delay a call for backup during a police chase.

# Build

## Design considerations

I initially intended to build a custom image of Android Automotive for the BRZ and develop mobile applications that would mostly run as backgroud services and overlay themselves on top of Android to display relevant information. Unfortunately this turned out to be a rather lucrative task and as of this writing I have elected to build a simple Android application running on a mobile image. The advantages of Android Automotive are as follows:
- Better navigation with fully functional Google Maps (I am using the Khadas VIM4 for the head unit and it does not support Google Play Services so it cannot have any Google Maps functionality)
- Better media controls with proper Bluetooth integration (As far as I am aware, Android Mobile cannot be used as a A2DP sink without modifying the source code)
- Better boot times
Overall, I did not feel these advantages were enough to justify the increased complexity of building a custom Android Automotive image especially considering how many custom UI screens and functions I ended up incorporating.

The purpose of rebuilding the vehicle's UI is not only to provide a seamless means of interacting with additional functionality but also to fully hide any illegal functions on demand. As such, there must not be any visible hint of any countermeasure functionality on the inside and outside of the vehicle and as such the car is able to hide illegal functionality when in 'legal mode' which can be enabled using arbitrary key strokes or combinations. Once in legal mode, the user is able to unlock hidden functions by entering an arbitrary set of seemingly random keystrokes using buttons throughout the car's interior. The combination is such that it would be incredibly difficult to guess or mistakenly enter it.

## Hardware

### Computers

The car will contain a multitude of computers listed below alongside their purpose:
- Head Unit/Center Console (Khadas VIM4) --> Mostly displays data and video feeds, very little logic goes on here
- Diagnostic computer (RPi ?) --> Connects to OBDii port and reports back data as HTTP server on internal network
- Arduino head unit (Arduino Mega) --> Acts as interface between ethernet network and Arduino serial networks 
- Gauge cluster computer (RPi Zero?) --> Listens to CANBUS and ethernet network to display data
- Safety computer (nVidia Jetson NX?) --> Uses CV algorithms on vehicle cameras and exports HDMI feeds of cameras for head unit

Most of the hardware modifications done to the vehicle are exectued by Arduinos integrated throughout the vehicle that share a set of serial networks with the Arduino head unit computer. The list of integrated Arduinos as well as the model used is as follows:
- Head light manager (MEGA_EMBED) --> Used for light animations up front, has relays to control lights and voltage dividers to light input from car's computer as well as addressable LEDs integrated in the grill.
- Rear light manager (MEGA_EMBED) --> Same idea but for rear lights. This Arduino also has an accelerometer such that it can flash the brake lights when braking hard.
- Siren manager (NANO?) --> Has an SD card reader to store audio files and feeds audio to a dedicated amplifier for the vehicle's loud speaker.
- Mirror manager (NANO) --> Keeps track of mirror position and allows them to automatically tilt when backing up. One per mirror.
- HVAC manager (MEGA_EMBED) --> Provides data regarding car's HVAC system and is able to simulate button presses to modify HVAC settings. This Arduino also receives the 'reverse signal' from the car and forwards it to mirror managers etc.
- Diagnostic display button manager (NANO) --> Controls relays that simulate button presses to maintain functionality of old center console buttons. 
- Steering wheel button manager (STM32 "Black Pill") --> Converts steering wheel button presses into USB keyboard data for head unit computer. Also forwards keystrokes to Arduino manager so commands can be dispatched downstream and eliminate latency by avoiding going through the head unit computer.
- Power managers (MEGA_EMBED) --> Handles power delivery to components using large relay boards to provide active failover functionality and monitor current/voltage among vehicle power buses. Two of these will be installed: one in front near the head unit and one in the trunk.
- Audio manager (MEGA_EMBED) --> Handles audio amplifier settings (equalizer and volume) and simulates keystrokes on a Bluetooth dongle used to receive mobile audio. Since the head unit computer can't be used as a A2DP sink, I am using a standalone Bluetooth dongle to receive mobile audio. This allows me to control the music from the head unit however I won't be able to keep track of the song's progress or display the album cover.
- Controller (MEGA_FULL) --> Has a few serial buses to unite all child devices as well as an ethernet adapter to communicate with ethernet network. There is a serial bus for devices which regularly and consistently broadcast data such as the power managers, a bus for each inconsistent device such as the steering wheel manager, and a bus for devices that solely execute actions without providing feedback.

### Cameras

The planned camera layout is included below however two cameras are omitted: one on the interior and another on the right side mirror. Of the cameras that are visible, the green semicircles are [136-degree FOV cameras](https://www.aliexpress.com/item/1005004337827464.html) installed in the front windshield and above the rear license plate whereas the grey circles represent [180-degree cameras](https://www.aliexpress.com/item/1005004335144138.html) installed beneath side view mirrors of the car. Of the omitted cameras, the interior camera faces the driver and is used for eye tracking such that the touch screen functionality of the center console is not enabled unless the driver is looking at the monitor to prevent accidental input. I planned on including a front-facing camera on the right wing mirror to provide the driver with insight about any vehicles in the right lane ahead of the car that the driver may not be able to see. This camera is not included at this time since the 180-degree FOV camera installed beneath the right side mirror should theoretically capture any vehicles in the right lane and as such the extra camera should not be necessary. 

![Camera layout](/assets/img/brz/camera_layout.png)

### Steering Wheel Button Integration

Steering wheel buttons were added to BRZs in 2017 and mine is a 2013 so I purchased a salvage steering wheel in order to integrate its buttons into my systems. Should anybody else contemplate to do the same, be aware that even though steering wheels are cheap the airbag most certainly is not: a brand new OEM airbag for my car is $CAD 1100 from the dealer while a used one is ~$CAD 600.

The steering wheel uses a [STM32 "Black Pill" MCU](https://www.cnx-software.com/2019/12/24/stm32-black-pill-board-features-stm32f4-cortex-m4-mcu-optional-spi-flash/) to convert button presses into keyboard output for the Khadas VIM4 to understand. Furthermore, it connects to the Arduino serial network to circumvent the car's internal network when forwarding any hardware-related commands as this decreases latency. In order to program the STM32, I took apart the button clusters on each side of the 
![Steering wheel button connector](/assets/img/brz/steering_wheel_button_connector.jpg){: style="float: right; width:50%; height:80%; margin-left: 10px;"}
steering wheel and looked at the traces to figure out the function of each wire. My findings are listed below for anybody else intending to reverse engineer the steering wheel buttons on a BRZ (wires are listed from left to right, top to bottom, looking at the connector from behind as depicted to the right):
- Light green --> Volume and arrow keys of left side cluster
- Red --> Common of left side cluster
- Green --> Arrow keys of right side cluster
- Purple --> Enter and back key of right side cluster
- Yellow --> Common of right side cluster
- Black --> Call buttons, source button, left enter button, and voice button
- Blue --> Steering wheel ground
- Brown --> Cruise control pin 1
- Grey --> Cruise control pin 2
- Black + Yellow --> LED ground
- Light yellow --> LED VCC (3.3V works, not sure about 5V)

The 'voice' button on the right side of the steering wheel is wired to the left button cluster and its state is transmitted through the (light green or black) wire. Button states are transmitted by varying the resistance between the common pin of each button cluster and one of the two output pins of each button cluster. The Arduino interprets these using a pulldown resistor on each output pin as explained [here](https://www.circuitbasics.com/arduino-ohm-meter/). Each output wire has a default resistance of 100 kOhm between itself and the common except for the purple output wire which has a 200kOhm default resistance. The resulting resistance and output wire for any button press is listed below in hopes of saving someone else the effort required to decode these circuit boards:

| Left Side Cluster | Right Side Cluster |
| ------- | ------- |
| Source --> 115 Ohm BLACK | Up --> 330 Ohm GREEN |
| Call pickup --> 425 Ohm BLACK | Right --> 3.1 kOhm GREEN |
| Call hangup --> 225 Ohm BLACK | Down --> 1 kOhm GREEN |
| Volume up --> short LIGHT GREEN | Left --> short GREEN |
| Volume down --> 50 Ohm LIGHT GREEN | Enter --> 100 kOhm PURPLE |
| Right --> 115 Ohm LIGHT GREEN | Back --> 101 kOhm PURPLE |
| Left --> 245 Ohm LIGHT GREEN | Voice --> 50 Ohm BLACK |
| Enter --> short BLACK | |

### TODO check purple resistance values again, maybe swap resistors if necessary

### Lighting Modifications

Some of the modifications require extensive control of the vehicle's lights however I was not willing to alter anything about the car's stock lighting controls. My solution consists of two relays in series placed in between the car's lights and the control signal coming from the vehicle's computers: one solid state relay to toggle the light, and one mechanical relay capable of switching the light's power source from the car to a secondary 'always-on' supply. Using the circuit depicted below, any light of the vehicle can be turned on or off at will regardless of any input from the vehicle's internal computers.
![Light relay circuit](/assets/img/brz/light_control_circuit.png)

### CAD

The retrofit brackets for this vehicle were designed by first measuring and modelling the mount points to the vehicle before extruding a general shape to house all the required components. The components are then arranged on the aforementioned general shape such that their screw holes/mount points can be cut after which the bulk of the material is removed leaving a barebones structure which can be further broken down into smaller pieces to facilitate manufacturing.

The head unit bracket is a perfect example of this technique. The design was built symmetrically, and as such, I began by modelling the left side before mirroring it to generate the entire assembly. I knew I would need two 'platforms' to house all the required components so I began by measuring the mount hole positions from the old head unit and generating two basic mount 'ears' before extruding an arbitrary platform attached to each ear. The platforms were extended an arbitrary amount in both directions based on how much space I estimated to be available inside the vehicle's cavity and how far the head unit display would be mounted. The head unit bracket holds the following hardware as can be seen in the *PIC* to the right:

1. Head unit display
2. Khadas VIM4
3. Voltage regulator
4. Diagnostic computer
5. Driver-facing camera
6. Head unit Arduino? (would hasten getting reverse signal to mirror managers)

No amp needed up front since it's in the trunk from factory (woot woot)

## Visual User Interface

### Head Unit Display

The large head unit display is split horizontally into two sections: a 'big container' which is 2/3 of the display's width and a 'small container' which occupies the remaining space. The views displayed by the big container and their respective purpose are as follows:
- Navigation fragment --> Contains an interactive map that the user
- Lighting control fragment --> Handles interior accent colours and vehicle underlighting (legal light functions)
- Safety fragment --> Displays live view of cameras around the car as well as any computer vision-related safety warnings
- Settings fragment --> Allows user to modify settings of any subsystem 
- Defence fragment --> Compliments defence fragment in small container, displays advanced countermeasures

The views displayed by the small container and their respective purpose are as follows:
- Media fragment --> Handles media playback controls
- Diagnostic fragment --> Mirror of center console display, describes states of vehicle systems
- Soundboard fragment --> Enables playback of custom sounds through a loudspeaker in front of vehicle
- Pop-up defence fragment --> Brief rundown of coutermeasure states, this fragment is automatically overlayed when vehicle detects radar/lidar etc.
- Traffic advisor fragment --> Allows user to control illegal light patterns of vehicle including police and hazard strobes

In addition to the two primary fragment containers, a few fragments can be overlayed on top of the whole display in specific circumstances:
- Parking fragment --> Overlayed when vehicle is put into reverse by driver and persists until vehicle speeds up regardless of which gear the vehicle is in. This fragment provides data from parking sensors and cameras around vehicle to facilitate parking.
- Merging fragment --> Pops up when merging right, provides live view of traffic in right lane so driver can see all vehicles in adjacent lane and blindspot.

### Diagnostic Display

This display provides the same view as the diagnostic fragment from the head unit display however there are also be four buttons underneath this view to replace the physical buttons that used to be in the center console. Furthermore, this display is capable of opening in depth sub-system diagnostic dialogs and clear error codes as well as execute diagnostic actions whereas the head unit fragment solely provides status information. This display runs off the same computer as the head unit since it has shared views and processes similar data (TRUE?).

The touch screen functionality of this display is toggled on demand using an interior-facing camera installed next to the 12.3" head unit display to track the driver's eyes. As such, all touch screen functionality aside from the passenger seat warmer button will not function unless the driver is looking down towards the display.

### Gauge Cluster Display

Listens to car's CANBUS and displays the same information as was available with original gauge cluster though it also adds data for range and displays alerts from vehicle systems. (TRUE?) Furthermore, can be used to display night vision camera in front of vehicle to drive in less than optimal lighting conditions.

### Heads Up Display

Might scrap this but would display basic vehicle information.

## Interactive User Interface

The head unit and diagnostic displays have touchscreen functionality however the head unit display can also be controlled using steering wheel buttons for a hands free experience. The diagnostic display can only be used as a touch screen however the touch screen is disabled if the driver is not looking at the display in order to prevent misinput when shifting. 

The right side steering wheel buttons are used to control the contents of the big container while the left side steering wheel buttons are used for the small container's contents. Additionally, there are dedicated consistent buttons or combinations thereof that can be used to toggle critical functions such as the vehicle's legal mode regardless of what content is live at the time.
