I"<p>This page outlines the process of modifying the BRZ’s stock head unit to contain custom components. I maintained the casing of the original head unit to avoid designing custom mounting hardware and alleviate the need to reverse engineer the casing/mounting point dimensions.</p>

<h2 id="architecture">Architecture</h2>

<p><em>include block diagram of design here</em></p>

<h2 id="final-product">Final Product</h2>

<p><img src="/assets/img/brz/head_unit_assembly.jpg" alt="Head unit assembly process" style="float: right; width:50%; height:80%; margin-left: 10px;" /></p>

<p>The updated head unit was a very satisfying thing to assemble. It effectively assembles from bottom to top as you would a layered cake, with each ‘level’ of electronics stacking on top of each other. Each layer as well as the components it houses is discussed more in depth in the Internal CAD section. The pictures below display the assembly process and final result:</p>

<p><img src="/assets/img/brz/head_unit_internals_real.jpg" alt="Head unit internals" />
<img src="/assets/img/brz/final_head_unit.jpg" alt="Final head unit" /></p>

<p>The final product, pictured above, came out rather clean! There’s a ribon cable protruding from the front that goes to the main media display and there are a few small JST-SM connectors as well as some generic I/O on the back to interface with the center console display, CAN bus, and various other things. My initial plan was to mount the display to the head unit itself, but aligning it with the trim and designing a mount that can be secured while also being removeable for a display as large as mine proved incredibly difficult. I therefore settled for mounting the display in the trim piece itself with only a ribon cable connecting it to the head unit.</p>

<p>I found a blog post and managed to obtain the stock wiring plugs for the head unit (Metra 70-1761) to get power and interface with the vehicle’s speakers. Lastly, the head unit gets a few state-related signals from the car such as a reverse signal (to turn on the backup camera) and an illumination signal (to notify it when the running lights are on). Both of these signals are forwarded back out through the JST-SM connectors and will connect to a transceiver computer by the car’s OBD port such that they can be encoded into CAN packets that are passed through my CAN network. This allows all of my hardware to keep track of their state and reduces the amount of hardware required in the head unit itself.</p>

<h2 id="cad">CAD</h2>

<p>The head unit CAD solely consists of a mounting framework to include all the necessary hardware within the casing of the stock head unit. I initially intended to mount the media display to the head unit itself however I ended up simply mounting it to the trim piece which saved me a ton of work. Of the two pictures included below, the first shows the CAD of the internal framework that holds all the components in the head unit whereas the second is a picture of the assembled head unit. 
<img src="/assets/img/brz/head_unit_internals.png" alt="Head unit internals" /></p>

<p>The inside of the OEM head unit’s casing has been redesigned to utilize a series of stackable brackets providing mounting points for the following components:</p>

<ol>
  <li>Khadas VIM4 –&gt; Linux backend computer</li>
  <li>USB 5.1 sound card –&gt; Required since Khadas VIM4 does not have a DAC onboard</li>
  <li>RCA to HDMI converter –&gt; Used to convert thermal camera to HDMI since Khadas VIM4 has an HDMI in</li>
  <li>NVMe SSD –&gt; used for dashcam/blackbox purposes</li>
  <li>SPI CAN shield –&gt; connects Khadas VIM4 to the CAN bus</li>
  <li>Raspberry Pi 4B –&gt; Android frontend computer</li>
  <li>Head unit display driver boards –&gt; two boards, one for power delivery and another for logic</li>
  <li>2CH amplifier boards (2 of these) –&gt; amplify audio for FL, FR, RL, and RR channels</li>
  <li>5V regulator –&gt; provides 5V for Khadas VIM4, Raspberry Pi, USB DAC, and RCA to HDMI converter</li>
  <li>Voltage splitter –&gt; splits battery voltage for display driver, amplifiers, and 5V regulator which do not require upstream power regulation</li>
</ol>

<p>There are 4 total brackets in the CAD design depicted above. The bottom bracket solely holds the display driver and Raspberry Pi, the second bracket holds the VIM4 alongside its NVMe SSD and CAN shield, the third holds one of the amplifiers and the display driver’s power board, and the fourth holds the final amplifier alongside the 5V regulator, USB DAC, and RCA to HDMI converter. The third bracket has a gap on the right side of the image to provide clearance for the VIM4’s fan.</p>

<h2 id="behavioural-nightmares">Behavioural Nightmares</h2>

<p>There was no shortage of software issues when trying to get this head unit to function as a head unit. Part of the premise of this project was the idea that there was no way I could end up with less functionality than my original head unit, which would only really play bluetooth media. This statement remained rather untrue for the first couple weeks of having the new head unit installed for a variety of reasons which I will list below:</p>

<ul>
  <li>Wireplumber: This problem took a buddy and I many hours to solve because it is not thoroughly documented and we suspected many other things to be wrong. The issue was that Wireplumber would check for a logged in user and refuse to play audio unless someone was logged in. There ended up being a config file burried in Ubuntu’s filesystem that disabled this behaviour and allowed the system to play audio regardless of there being a user logged in. This issue also prevented a bluetooth device from being connected to the head unit since the Khadas VIM4 would instantaneously drop the connection as a result of there being no audio session manager active.</li>
</ul>
:ET